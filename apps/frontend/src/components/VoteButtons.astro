---
const { postId, score, type = 'post' } = Astro.props;
---

<div class="vote-controls" data-id={postId} data-type={type} data-score={score}>
  <button class="vote-btn up" aria-label="Upvote">▲</button>
  <span class="score">{score}</span>
  <button class="vote-btn down" aria-label="Downvote">▼</button>
</div>

<style>
  .vote-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
  }

  .vote-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.125rem;
    color: var(--text-tertiary);
    padding: var(--space-1);
    line-height: 1;
    transition: color 0.15s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.15s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
  }

  .vote-btn:hover {
    color: var(--brand);
    opacity: 1;
  }

  .vote-btn:active {
    transform: scale(0.9);
  }

  .vote-btn.voted {
    color: var(--brand);
    font-weight: var(--font-bold);
  }

  .score {
    font-weight: var(--font-bold);
    font-size: var(--text-sm);
    color: var(--text-primary);
    font-variant-numeric: tabular-nums;
    min-width: 2ch;
    text-align: center;
  }
</style>

<script>
  import { isAuthenticated } from '../lib/auth';
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:51728';

  document.querySelectorAll('.vote-controls').forEach(el => {
    const id = el.getAttribute('data-id');
    const type = el.getAttribute('data-type');
    const upBtn = el.querySelector('.up');
    const downBtn = el.querySelector('.down');
    const scoreSpan = el.querySelector('.score');

    async function vote(value: number) {
      if (!isAuthenticated()) {
        window.location.href = '/login';
        return;
      }

      const token = localStorage.getItem('auth_token');
      const endpoint = type === 'post'
        ? `${API_URL}/api/posts/${id}/vote`
        : `${API_URL}/api/posts/comments/${id}/vote`;

      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ value }),
      });

      if (res.ok) {
        const data = await res.json();
        scoreSpan!.textContent = data.score;

        upBtn!.classList.toggle('voted', data.userVote === 1);
        downBtn!.classList.toggle('voted', data.userVote === -1);
      }
    }

    upBtn?.addEventListener('click', () => {
      const current = upBtn.classList.contains('voted');
      vote(current ? 0 : 1);
    });

    downBtn?.addEventListener('click', () => {
      const current = downBtn.classList.contains('voted');
      vote(current ? 0 : -1);
    });
  });
</script>
