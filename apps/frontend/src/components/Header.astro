---
// Responsive header with hamburger menu
import { Search, Bell, Bookmark, Sun, Moon } from 'lucide-astro';
---

<header class="main-header">
  <div class="header-container">
    <div class="header-left">
      <a href="/" class="logo-icon">V</a>
      <a href="/" class="logo-text">VapeIndex</a>
    </div>

    <!-- Hamburger Menu Toggle -->
    <input type="checkbox" id="menu-toggle" class="menu-toggle" />
    <label for="menu-toggle" class="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </label>

    <!-- Navigation -->
    <nav class="nav-menu">
      <div class="nav-links">
        <a href="/new">new</a>
        <a href="/past">past</a>
        <a href="/comments">comments</a>
        <a href="/ask">ask</a>
        <a href="/show">show</a>
        <a href="/submit">submit</a>
        <a href="/wiki">wiki</a>
      </div>
      <div class="nav-auth">
        <a href="/search" class="nav-icon" title="Search">
          <Search size={16} />
        </a>
        <div class="notifications-wrapper">
          <button id="notifications-btn" class="nav-icon notifications-btn" title="Notifications">
            <Bell size={16} />
            <span id="notif-badge" class="notif-badge" style="display: none;"></span>
          </button>
          <div id="notifications-dropdown" class="notifications-dropdown" style="display: none;">
            <div class="notif-header">
              <h3>Notifications</h3>
              <button id="mark-all-read" class="mark-all-btn">Mark all read</button>
            </div>
            <div id="notifications-list" class="notifications-list">
              <div class="notif-loading">Loading...</div>
            </div>
          </div>
        </div>
        <a href="/saved" class="nav-icon" title="Saved">
          <Bookmark size={16} />
        </a>
        <button id="theme-toggle" class="theme-toggle nav-icon" aria-label="Toggle dark mode" title="Theme">
          <Sun class="sun-icon" size={16} />
          <Moon class="moon-icon" size={16} />
        </button>
        <span class="nav-separator">|</span>

        <!-- Auth state (dynamically updated) -->
        <div id="auth-state" class="auth-state">
          <a href="/login" class="nav-link">login</a>
          <span class="nav-separator">|</span>
          <a href="/register" class="nav-link">register</a>
        </div>
      </div>
    </nav>
  </div>
</header>

<script>
  import { $user, $isAuthenticated } from '../lib/authStore';
  import { getStoredUser, logout } from '../lib/auth';

  // Dark mode toggle functionality
  const themeToggle = document.getElementById('theme-toggle');
  const html = document.documentElement;

  // Check for saved theme preference or default to system preference
  const savedTheme = localStorage.getItem('theme');
  const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  if (savedTheme) {
    html.setAttribute('data-theme', savedTheme);
  } else if (systemPrefersDark) {
    html.setAttribute('data-theme', 'dark');
  }

  // Toggle theme
  themeToggle?.addEventListener('click', () => {
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  });

  // Auth state management
  const authStateDiv = document.getElementById('auth-state');

  function updateAuthState() {
    const user = getStoredUser();

    if (user && authStateDiv) {
      // User is logged in - show username and logout
      authStateDiv.innerHTML = `
        <a href="/user/${user.username}" class="nav-link" title="${user.karma || 0} karma">
          ${user.username} (${user.karma || 0})
        </a>
        <span class="nav-separator">|</span>
        <a href="#" id="logout-btn" class="nav-link">logout</a>
      `;

      // Add logout handler
      const logoutBtn = document.getElementById('logout-btn');
      logoutBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        await logout();
        window.location.href = '/';
      });
    } else {
      // User is not logged in - show login/register
      authStateDiv!.innerHTML = `
        <a href="/login" class="nav-link">login</a>
        <span class="nav-separator">|</span>
        <a href="/register" class="nav-link">register</a>
      `;
    }
  }

  // Update auth state on load
  updateAuthState();

  // Listen for auth state changes (for when user logs in/out)
  $isAuthenticated.subscribe(() => {
    updateAuthState();
  });

  // Notifications functionality
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:51728';
  const notificationsBtn = document.getElementById('notifications-btn');
  const notificationsDropdown = document.getElementById('notifications-dropdown');
  const notificationsList = document.getElementById('notifications-list');
  const notifBadge = document.getElementById('notif-badge');
  const markAllReadBtn = document.getElementById('mark-all-read');

  let notificationsOpen = false;

  // Fetch unread count
  async function fetchUnreadCount() {
    const token = localStorage.getItem('auth_token');
    if (!token) return;

    try {
      const response = await fetch(`${API_URL}/api/notifications/unread-count`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const data = await response.json();
        if (data.count > 0) {
          notifBadge!.textContent = data.count > 99 ? '99+' : data.count.toString();
          notifBadge!.style.display = 'flex';
        } else {
          notifBadge!.style.display = 'none';
        }
      }
    } catch (error) {
      console.error('Failed to fetch unread count:', error);
    }
  }

  // Fetch notifications
  async function fetchNotifications() {
    const token = localStorage.getItem('auth_token');
    if (!token) return;

    try {
      const response = await fetch(`${API_URL}/api/notifications?limit=10`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const data = await response.json();
        renderNotifications(data.notifications);
      }
    } catch (error) {
      console.error('Failed to fetch notifications:', error);
      notificationsList!.innerHTML = '<div class="notif-error">Failed to load notifications</div>';
    }
  }

  // Render notifications
  function renderNotifications(notifications: any[]) {
    if (notifications.length === 0) {
      notificationsList!.innerHTML = '<div class="notif-empty">No notifications</div>';
      return;
    }

    notificationsList!.innerHTML = notifications.map(notif => `
      <div class="notif-item ${notif.is_read ? '' : 'unread'}" data-id="${notif.id}" data-link="${notif.link}">
        <div class="notif-content">
          <div class="notif-text">${notif.content}</div>
          <div class="notif-time">${formatNotifTime(notif.created_at)}</div>
        </div>
        ${!notif.is_read ? '<div class="notif-dot"></div>' : ''}
      </div>
    `).join('');

    // Add click handlers
    document.querySelectorAll('.notif-item').forEach(item => {
      item.addEventListener('click', async () => {
        const notifId = item.getAttribute('data-id');
        const link = item.getAttribute('data-link');

        // Mark as read
        if (item.classList.contains('unread')) {
          await markAsRead(notifId!);
        }

        // Navigate to link
        window.location.href = link!;
      });
    });
  }

  // Mark notification as read
  async function markAsRead(notifId: string) {
    const token = localStorage.getItem('auth_token');
    if (!token) return;

    try {
      await fetch(`${API_URL}/api/notifications/${notifId}/read`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      fetchUnreadCount();
    } catch (error) {
      console.error('Failed to mark as read:', error);
    }
  }

  // Mark all as read
  markAllReadBtn?.addEventListener('click', async () => {
    const token = localStorage.getItem('auth_token');
    if (!token) return;

    try {
      await fetch(`${API_URL}/api/notifications/mark-all-read`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      fetchUnreadCount();
      fetchNotifications();
    } catch (error) {
      console.error('Failed to mark all as read:', error);
    }
  });

  // Toggle notifications dropdown
  notificationsBtn?.addEventListener('click', () => {
    notificationsOpen = !notificationsOpen;
    notificationsDropdown!.style.display = notificationsOpen ? 'block' : 'none';

    if (notificationsOpen) {
      fetchNotifications();
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (notificationsOpen &&
        !notificationsBtn?.contains(e.target as Node) &&
        !notificationsDropdown?.contains(e.target as Node)) {
      notificationsOpen = false;
      notificationsDropdown!.style.display = 'none';
    }
  });

  // Format notification time
  function formatNotifTime(timestamp: number): string {
    const now = Math.floor(Date.now() / 1000);
    const age = now - timestamp;

    if (age < 60) return 'just now';
    if (age < 3600) return `${Math.floor(age / 60)}m ago`;
    if (age < 86400) return `${Math.floor(age / 3600)}h ago`;
    if (age < 2592000) return `${Math.floor(age / 86400)}d ago`;
    return `${Math.floor(age / 2592000)}mo ago`;
  }

  // Fetch unread count on load (if authenticated)
  if (getStoredUser()) {
    fetchUnreadCount();
    // Poll for new notifications every 30 seconds
    setInterval(fetchUnreadCount, 30000);
  }
</script>

<style>
  .main-header {
    background: var(--brand);
    padding: var(--space-1) 0;
    position: sticky;
    top: 0;
    z-index: 1000;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    backdrop-filter: blur(8px);
  }

  .header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: var(--max-width-full);
    margin: 0 auto;
    padding: 0 var(--space-4);
    position: relative;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    z-index: 2;
  }

  .logo-icon {
    background: white;
    width: 1.125rem;
    height: 1.125rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 0.75rem;
    color: var(--brand);
    text-decoration: none;
    border: 1px solid white;
  }

  .logo-text {
    font-weight: 700;
    font-size: 0.875rem;
    color: white;
    text-decoration: none;
  }

  /* Hamburger Menu */
  .menu-toggle {
    display: none;
  }

  .hamburger {
    display: none;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
    padding: 0.5rem;
    z-index: 2;
  }

  .hamburger span {
    display: block;
    width: 24px;
    height: 3px;
    background: white;
    border-radius: 2px;
    transition: all 0.3s;
  }

  /* Navigation */
  .nav-menu {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    margin-left: 0.75rem;
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: 0;
    font-size: 0.875rem;
  }

  .nav-links a {
    color: rgba(255, 255, 255, 0.85);
    text-decoration: none;
    padding: 0 var(--space-2);
    border-left: 1px solid rgba(255, 255, 255, 0.15);
    white-space: nowrap;
    transition: color 0.15s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: var(--font-regular);
    font-size: var(--text-sm);
  }

  .nav-links a:first-child {
    border-left: none;
  }

  .nav-links a:hover {
    color: white;
    opacity: 1;
  }

  .nav-links a:active {
    opacity: 0.7;
  }

  .nav-auth {
    margin-left: auto;
    font-size: var(--text-sm);
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .nav-icon {
    color: rgba(255, 255, 255, 0.85);
    display: flex;
    align-items: center;
    text-decoration: none;
    transition: color 0.15s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }

  .nav-icon:hover {
    color: white;
    opacity: 1;
  }

  .nav-icon:active {
    opacity: 0.7;
  }

  .nav-icon :global(svg) {
    stroke: currentColor;
  }

  .nav-separator {
    color: rgba(255, 255, 255, 0.25);
    font-weight: var(--font-regular);
    user-select: none;
  }

  .nav-link {
    color: rgba(255, 255, 255, 0.85);
    text-decoration: none;
    font-weight: var(--font-regular);
    transition: color 0.15s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .nav-link:hover {
    color: white;
    opacity: 1;
  }

  .nav-link:active {
    opacity: 0.7;
  }

  .auth-state {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  /* Theme Toggle */
  .theme-toggle {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .theme-toggle :global(svg) {
    stroke: white;
  }

  /* Show sun in dark mode, moon in light mode */
  html[data-theme="dark"] :global(.sun-icon) {
    display: block;
  }

  html[data-theme="dark"] :global(.moon-icon) {
    display: none;
  }

  html:not([data-theme="dark"]) :global(.sun-icon) {
    display: none;
  }

  html:not([data-theme="dark"]) :global(.moon-icon) {
    display: block;
  }

  /* Notifications */
  .notifications-wrapper {
    position: relative;
  }

  .notifications-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    position: relative;
  }

  .notif-badge {
    position: absolute;
    top: -6px;
    right: -8px;
    background: #ef4444;
    color: white;
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.125rem 0.3rem;
    border-radius: 10px;
    min-width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  .notifications-dropdown {
    position: absolute;
    top: calc(100% + var(--space-2));
    right: 0;
    width: 360px;
    max-height: 480px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-primary);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    overflow: hidden;
  }

  .notif-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    border-bottom: 1px solid var(--border-primary);
  }

  .notif-header h3 {
    font-size: var(--text-base);
    font-weight: var(--font-bold);
    margin: 0;
    color: var(--text-primary);
  }

  .mark-all-btn {
    background: none;
    border: none;
    color: var(--brand);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    padding: 0;
    transition: opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .mark-all-btn:hover {
    opacity: 0.8;
  }

  .mark-all-btn:active {
    opacity: 0.6;
  }

  .notifications-list {
    max-height: 400px;
    overflow-y: auto;
  }

  .notif-item {
    padding: var(--space-4);
    border-bottom: 1px solid var(--border-primary);
    cursor: pointer;
    transition: background-color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-3);
  }

  .notif-item:hover {
    background: var(--bg-hover);
  }

  .notif-item:active {
    background: var(--interactive-active);
  }

  .notif-item.unread {
    background: rgba(124, 58, 237, 0.04);
  }

  .notif-item:last-child {
    border-bottom: none;
  }

  .notif-content {
    flex: 1;
    min-width: 0;
  }

  .notif-text {
    font-size: var(--text-sm);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
    line-height: var(--leading-normal);
  }

  .notif-time {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
  }

  .notif-dot {
    width: 6px;
    height: 6px;
    background: var(--brand);
    border-radius: 50%;
    flex-shrink: 0;
  }

  .notif-loading,
  .notif-empty,
  .notif-error {
    padding: var(--space-8) var(--space-4);
    text-align: center;
    color: var(--text-secondary);
    font-size: var(--text-sm);
  }

  .notif-error {
    color: var(--error);
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .hamburger {
      display: flex;
    }

    .nav-menu {
      position: fixed;
      top: 0;
      right: -100%;
      width: 280px;
      height: 100vh;
      background: var(--brand);
      flex-direction: column;
      align-items: flex-start;
      padding: 4rem 1.5rem 1.5rem;
      transition: right 0.3s ease;
      gap: 2rem;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
    }

    .menu-toggle:checked ~ .nav-menu {
      right: 0;
    }

    .menu-toggle:checked ~ .hamburger span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .menu-toggle:checked ~ .hamburger span:nth-child(2) {
      opacity: 0;
    }

    .menu-toggle:checked ~ .hamburger span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    .nav-links {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
      width: 100%;
    }

    .nav-links a {
      border-left: none;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding: 0.75rem 0;
      width: 100%;
      font-size: 1rem;
      font-weight: 600;
    }

    .nav-auth {
      margin-left: 0;
      width: 100%;
    }

    .login-link {
      display: block;
      background: white;
      color: var(--brand);
      padding: 0.75rem 1.5rem;
      border-radius: 0.375rem;
      text-align: center;
      font-weight: 700;
    }

    .notifications-dropdown {
      width: calc(100vw - 2rem);
      max-width: 360px;
      right: auto;
      left: 50%;
      transform: translateX(-50%);
    }
  }

  @media (max-width: 768px) {
    .header-container {
      padding: 0 var(--space-2);
    }
  }

  @media (max-width: 580px) {
    .logo-text {
      font-size: 0.75rem;
    }
  }
</style>
