---
const { postId } = Astro.props;
---

<div class="comments-section" data-post-id={postId}>
  <h3>Comments</h3>

  <div class="comment-form-container">
    <form class="comment-form">
      <textarea placeholder="What are your thoughts?" required></textarea>
      <button type="submit">Comment</button>
    </form>
  </div>

  <div class="comments-list"></div>
</div>

<style>
  .comments-section { margin-top: 2rem; }
  h3 { font-size: 1.25rem; margin-bottom: 1rem; }
  .comment-form { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 2rem; }
  .comment-form textarea { width: 100%; min-height: 100px; padding: 0.75rem; border: 1px solid var(--border); resize: vertical; font-family: inherit; }
  .comment-form button { align-self: flex-end; background: var(--brand); color: white; padding: 0.5rem 1.5rem; border: none; font-weight: 600; cursor: pointer; }
  .comment { border-left: 2px solid var(--border); padding-left: 1rem; margin-bottom: 1rem; }
  .comment-header { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); }
  .comment-author { font-weight: 600; color: var(--text-primary); }
  .comment-content { margin-bottom: 0.5rem; line-height: 1.6; }
  .comment-actions { display: flex; gap: 1rem; font-size: 0.8125rem; }
  .comment-actions button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-weight: 600; }
  .comment-actions button:hover { color: var(--brand); }
  .replies { margin-left: 1.5rem; margin-top: 1rem; }
  .reply-form, .edit-comment-form { display: none; margin-top: 0.5rem; }
  .reply-form.show, .edit-comment-form { display: flex; flex-direction: column; gap: 0.5rem; }
  .reply-form textarea, .edit-comment-form textarea { padding: 0.5rem; border: 1px solid var(--border); min-height: 60px; font-family: inherit; resize: vertical; width: 100%; }
  .reply-form button[type="submit"], .edit-comment-form button[type="submit"] { background: var(--brand); color: white; padding: 0.35rem 1rem; border: none; font-size: 0.875rem; cursor: pointer; font-weight: 600; }
  .reply-form .cancel-reply, .edit-comment-form .cancel-edit-comment { background: none; color: var(--text-secondary); padding: 0.35rem 1rem; border: 1px solid var(--border); font-size: 0.875rem; cursor: pointer; }
  .reply-form .cancel-reply:hover, .edit-comment-form .cancel-edit-comment:hover { color: var(--text-primary); border-color: var(--text-secondary); }
  .vote-comment-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.8125rem; font-weight: 600; padding: 0; }
  .vote-comment-btn:hover { color: var(--brand); }
  .comment-score { font-weight: 600; color: var(--text-primary); margin: 0 0.25rem; }
</style>

<script>
  import { isAuthenticated, getStoredUser } from '../lib/auth';
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:51728';

  const section = document.querySelector('.comments-section');
  const postId = section?.getAttribute('data-post-id');
  const form = section?.querySelector('.comment-form') as HTMLFormElement;
  const textarea = form?.querySelector('textarea') as HTMLTextAreaElement;
  const list = section?.querySelector('.comments-list');

  function formatTimeAgo(timestamp: number): string {
    const now = Math.floor(Date.now() / 1000);
    const age = now - timestamp;

    if (age < 60) return `${age}s ago`;
    if (age < 3600) return `${Math.floor(age / 60)}m ago`;
    if (age < 86400) return `${Math.floor(age / 3600)}h ago`;
    if (age < 2592000) return `${Math.floor(age / 86400)}d ago`;
    if (age < 31536000) return `${Math.floor(age / 2592000)}mo ago`;
    return `${Math.floor(age / 31536000)}y ago`;
  }

  function renderComment(comment: any, depth: number = 0): string {
    const replyFormId = `reply-form-${comment.id}`;
    const editFormId = `edit-form-${comment.id}`;
    const editedText = comment.editedAt ? ` (edited ${formatTimeAgo(comment.editedAt)})` : '';

    return `
      <div class="comment" data-comment-id="${comment.id}" data-author-id="${comment.authorId}" style="margin-left: ${depth * 1.5}rem;">
        <div class="comment-header">
          <span class="comment-author">${comment.author}</span>
          <span>${comment.authorKarma || 0} karma</span>
          <span>•</span>
          <span>${formatTimeAgo(comment.createdAt)}${editedText}</span>
        </div>
        <div class="comment-content" id="content-${comment.id}">${comment.content}</div>
        <form class="edit-comment-form" id="${editFormId}" style="display: none;">
          <textarea required>${comment.content}</textarea>
          <div style="display: flex; gap: 0.5rem; align-self: flex-end;">
            <button type="submit">Save</button>
            <button type="button" class="cancel-edit-comment">Cancel</button>
          </div>
        </form>
        <div class="comment-actions">
          <button class="vote-comment-btn" data-comment-id="${comment.id}" data-value="1">▲ upvote</button>
          <span class="comment-score" data-comment-id="${comment.id}">${comment.score}</span>
          <button class="vote-comment-btn" data-comment-id="${comment.id}" data-value="-1">▼ downvote</button>
          <button class="reply-btn" data-comment-id="${comment.id}">reply</button>
          <button class="edit-comment-btn" data-comment-id="${comment.id}" style="display: none;">edit</button>
          <button class="delete-comment-btn" data-comment-id="${comment.id}" style="display: none;">delete</button>
        </div>
        <form class="reply-form" id="${replyFormId}" data-parent-id="${comment.id}">
          <textarea placeholder="Write your reply..." required></textarea>
          <div style="display: flex; gap: 0.5rem; align-self: flex-end;">
            <button type="submit">Reply</button>
            <button type="button" class="cancel-reply">Cancel</button>
          </div>
        </form>
        ${comment.replies && comment.replies.length > 0
          ? `<div class="replies">${comment.replies.map((reply: any) => renderComment(reply, depth + 1)).join('')}</div>`
          : ''}
      </div>
    `;
  }

  async function loadComments() {
    try {
      const res = await fetch(`${API_URL}/api/posts/${postId}/comments`);

      if (!res.ok) {
        if (list) list.innerHTML = '<p style="color: var(--text-secondary);">Failed to load comments.</p>';
        return;
      }

      const data = await res.json();

      if (!data.comments || data.comments.length === 0) {
        if (list) list.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No comments yet. Be the first!</p>';
        return;
      }

      if (list) {
        list.innerHTML = data.comments.map((c: any) => renderComment(c, 0)).join('');
        attachCommentEventListeners();
      }
    } catch (error) {
      console.error('Load comments error:', error);
      if (list) list.innerHTML = '<p style="color: var(--text-secondary);">Failed to load comments.</p>';
    }
  }

  function attachCommentEventListeners() {
    // Show edit/delete buttons for comment authors
    const user = getStoredUser();
    if (user) {
      document.querySelectorAll('.comment').forEach(comment => {
        const authorId = parseInt(comment.getAttribute('data-author-id') || '0');
        if (user.id === authorId) {
          const commentId = comment.getAttribute('data-comment-id');
          const editBtn = comment.querySelector(`.edit-comment-btn[data-comment-id="${commentId}"]`) as HTMLElement;
          const deleteBtn = comment.querySelector(`.delete-comment-btn[data-comment-id="${commentId}"]`) as HTMLElement;
          if (editBtn) editBtn.style.display = 'inline';
          if (deleteBtn) deleteBtn.style.display = 'inline';
        }
      });
    }

    // Reply button handlers
    document.querySelectorAll('.reply-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const commentId = btn.getAttribute('data-comment-id');
        const replyForm = document.getElementById(`reply-form-${commentId}`) as HTMLFormElement;
        if (replyForm) {
          replyForm.classList.toggle('show');
        }
      });
    });

    // Cancel reply handlers
    document.querySelectorAll('.cancel-reply').forEach(btn => {
      btn.addEventListener('click', () => {
        const form = btn.closest('.reply-form') as HTMLFormElement;
        if (form) {
          form.classList.remove('show');
          form.reset();
        }
      });
    });

    // Reply form submit handlers
    document.querySelectorAll('.reply-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formEl = e.target as HTMLFormElement;
        const textarea = formEl.querySelector('textarea') as HTMLTextAreaElement;
        const parentId = formEl.getAttribute('data-parent-id');

        if (await postComment(textarea.value, parseInt(parentId!))) {
          textarea.value = '';
          formEl.classList.remove('show');
        }
      });
    });

    // Vote comment handlers
    document.querySelectorAll('.vote-comment-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!isAuthenticated()) {
          window.location.href = '/login';
          return;
        }

        const commentId = btn.getAttribute('data-comment-id');
        const value = parseInt(btn.getAttribute('data-value')!);
        const token = localStorage.getItem('auth_token');

        const res = await fetch(`${API_URL}/api/posts/comments/${commentId}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ value }),
        });

        if (res.ok) {
          const data = await res.json();
          const scoreSpan = document.querySelector(`.comment-score[data-comment-id="${commentId}"]`);
          if (scoreSpan) scoreSpan.textContent = data.score;
        }
      });
    });

    // Edit comment handlers
    document.querySelectorAll('.edit-comment-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const commentId = btn.getAttribute('data-comment-id');
        const contentDiv = document.getElementById(`content-${commentId}`);
        const editForm = document.getElementById(`edit-form-${commentId}`) as HTMLFormElement;
        if (contentDiv && editForm) {
          contentDiv.style.display = 'none';
          editForm.style.display = 'flex';
        }
      });
    });

    document.querySelectorAll('.cancel-edit-comment').forEach(btn => {
      btn.addEventListener('click', () => {
        const form = btn.closest('.edit-comment-form') as HTMLFormElement;
        const commentId = form?.id.replace('edit-form-', '');
        const contentDiv = document.getElementById(`content-${commentId}`);
        if (contentDiv && form) {
          contentDiv.style.display = 'block';
          form.style.display = 'none';
        }
      });
    });

    document.querySelectorAll('.edit-comment-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthenticated()) {
          window.location.href = '/login';
          return;
        }

        const formEl = e.target as HTMLFormElement;
        const commentId = formEl.id.replace('edit-form-', '');
        const textarea = formEl.querySelector('textarea') as HTMLTextAreaElement;
        const token = localStorage.getItem('auth_token');

        const res = await fetch(`${API_URL}/api/posts/comments/${commentId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ content: textarea.value }),
        });

        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to edit comment');
        }
      });
    });

    // Delete comment handlers
    document.querySelectorAll('.delete-comment-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this comment? This cannot be undone.')) return;
        if (!isAuthenticated()) {
          window.location.href = '/login';
          return;
        }

        const commentId = btn.getAttribute('data-comment-id');
        const token = localStorage.getItem('auth_token');

        const res = await fetch(`${API_URL}/api/posts/comments/${commentId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` },
        });

        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to delete comment');
        }
      });
    });
  }

  async function postComment(content: string, parentId?: number) {
    if (!isAuthenticated()) {
      window.location.href = '/login';
      return;
    }

    const token = localStorage.getItem('auth_token');
    const res = await fetch(`${API_URL}/api/posts/${postId}/comments`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ content, parentId }),
    });

    if (res.ok) {
      loadComments();
      return true;
    }
    return false;
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (await postComment(textarea.value)) {
      textarea.value = '';
    }
  });

  loadComments();
</script>
