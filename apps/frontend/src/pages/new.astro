---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { ChevronUp, ChevronDown, MessageSquare, Eye, Share2, Bookmark } from 'lucide-astro';
import '../styles/posts.css';
import { fetchPosts, fetchBoards, fetchStats } from '../lib/api';

// Fetch real data from API
const [newPosts, boards, stats] = await Promise.all([
  fetchPosts('new', 15),
  fetchBoards(),
  fetchStats()
]);

const trendingBoards = boards.slice(0, 4);

// Old mock data (backup):
const oldPosts = [
  { id: '20', title: 'Just got my first pod system - Caliburn AK2!', board: 'Beginner', boardSlug: 'beginner', score: 12, comments: 5, author: 'first_timer', authorKarma: 45, time: '5m', views: 234, hot: false, awarded: false },
  { id: '19', title: 'Smok Nord 5 vs Vaporesso XROS 3 - which one?', board: 'Pod Systems', boardSlug: 'pods', score: 23, comments: 8, author: 'pod_seeker', authorKarma: 156, time: '15m', views: 456, hot: false, awarded: false },
  { id: '18', title: 'Best place to buy authentic disposables online?', board: 'Disposables', boardSlug: 'disposables', score: 34, comments: 12, author: 'authentic_buyer', authorKarma: 289, time: '32m', views: 678, hot: false, awarded: false },
  { id: '17', title: 'DIY e-liquid recipe - Strawberry Cheesecake', board: 'DIY', boardSlug: 'diy', score: 45, comments: 18, author: 'diy_master', authorKarma: 1234, time: '1h', views: 891, hot: false, awarded: false },
  { id: '16', title: 'Puffco Peak vs Pax Plus for concentrates?', board: 'Dry Herb', boardSlug: 'dryherb', score: 28, comments: 15, author: 'concentrate_fan', authorKarma: 567, time: '1h', views: 543, hot: false, awarded: false },
  { id: '15', title: 'Anyone tried the new Geek Bar Pulse? Thoughts?', board: 'Disposables', boardSlug: 'disposables', score: 134, comments: 48, author: 'disposable_fan', authorKarma: 1823, time: '2h', views: 2145, hot: false, awarded: false },
  { id: '14', title: 'Lost Vape Thelema DNA250C - 6 month review', board: 'Reviews', boardSlug: 'reviews', score: 189, comments: 52, author: 'reviewer_pro', authorKarma: 9234, time: '3h', views: 2341, hot: false, awarded: false },
  { id: '13', title: 'Storz & Bickel Mighty+ price tracking - all time low?', board: 'Deals', boardSlug: 'deals', score: 267, comments: 41, author: 'price_watcher', authorKarma: 6734, time: '4h', views: 2734, hot: false, awarded: false },
  { id: '12', title: 'Complete beginner - what device should I buy?', board: 'Beginner', boardSlug: 'beginner', score: 98, comments: 73, author: 'newbie2025', authorKarma: 12, time: '5h', views: 1892, hot: false, awarded: false },
  { id: '11', title: 'Built my first triple-core fused clapton coils! Tips?', board: 'DIY', boardSlug: 'diy', score: 145, comments: 67, author: 'coil_builder', authorKarma: 987, time: '6h', views: 1456, hot: false, awarded: false },
];
---

<Layout>
  <Header />

  <main class="main-content">
    <div class="layout-container">

      <!-- Left Sidebar - Boards -->
      <aside class="sidebar-left">
        <!-- Create Board CTA -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem;">
          <div style="font-weight: 800; font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-primary);">Create Your Community</div>
          <p style="font-size: 0.8125rem; color: var(--text-secondary); margin: 0 0 0.75rem 0; line-height: 1.5;">
            Start a new board and build your own community around any vaping topic.
          </p>
          <a href="/create-board" style="display: block; background: var(--brand); color: white; padding: 0.5rem 1rem; border-radius: 0; text-align: center; font-weight: 700; font-size: 0.875rem; text-decoration: none;">
            + Create Board
          </a>
        </div>

        <!-- Boards List -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary);">
          <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-primary);">
            <h3 style="font-size: 0.875rem; font-weight: 800; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">
              Browse Boards
            </h3>
          </div>
          <div style="max-height: 500px; overflow-y: auto;">
            {boards.map(board => (
              <a href={`/b/${board.slug}`} style={`display: block; padding: 0.75rem 1rem; color: var(--text-primary); text-decoration: none; border-left: 3px solid ${board.color}; border-bottom: 1px solid var(--divider);`}>
                <div style="font-weight: 700; font-size: 0.9375rem; margin-bottom: 0.25rem; color: var(--text-primary);">{board.name}</div>
                <div style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.375rem;">{board.description}</div>
                <div style="font-size: 0.75rem; color: var(--text-primary); display: flex; gap: 1rem; font-weight: 600;">
                  <span>{board.posts.toLocaleString()} posts</span>
                  <span>{board.members.toLocaleString()} members</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </aside>

      <!-- Main Content - Posts Feed -->
      <div class="main-feed">
        <!-- Filter Bar -->
        <div class="filter-bar">
          <div class="filter-tabs">
            <a href="/" class="filter-tab">hot</a>
            <a href="/new" class="filter-tab active">new</a>
            <a href="/top" class="filter-tab">top</a>
            <a href="/rising" class="filter-tab">rising</a>
          </div>
          <div class="filter-actions">
            <a href="/submit" class="create-post-btn">submit</a>
          </div>
        </div>

        <!-- Posts List -->
        <div class="posts-container">
          {newPosts.map((post, i) => (
            <article class="post-card">
              <!-- Voting Column -->
              <div class="vote-column">
                <button class="vote-btn vote-up" aria-label="Upvote">
                  <ChevronUp size={16} />
                </button>
                <span class="vote-score">{post.score}</span>
                <button class="vote-btn vote-down" aria-label="Downvote">
                  <ChevronDown size={16} />
                </button>
              </div>

              <!-- Content Column -->
              <div class="post-content">
                <!-- Meta Info -->
                <div class="post-meta">
                  <a href={`/b/${post.boardSlug}`} class="board-tag" style={`color: ${boards.find(b => b.slug === post.boardSlug)?.color || '#7C3AED'}`}>
                    b/{post.boardSlug}
                  </a>
                  <span class="meta-separator">â€¢</span>
                  <span class="post-author">
                    <a href={`/u/${post.author}`} class="author-link">u/{post.author}</a>
                    <span class="author-karma">{post.authorKarma.toLocaleString()}</span>
                  </span>
                  <span class="meta-separator">â€¢</span>
                  <time class="post-time">{post.time}</time>
                </div>

                <!-- Title -->
                <h2 class="post-title">
                  <a href={`/post/${post.id}`}>{post.title}</a>
                </h2>

                <!-- Actions -->
                <div class="post-actions">
                  <a href={`/post/${post.id}`} class="action-btn action-comment">
                    <MessageSquare size={14} />
                    <span>{post.comments}</span>
                  </a>
                  <span class="action-btn action-views">
                    <Eye size={14} />
                    <span>{post.views.toLocaleString()}</span>
                  </span>
                  <button class="action-btn action-share">
                    <Share2 size={14} />
                    <span>Share</span>
                  </button>
                  <button class="action-btn action-save">
                    <Bookmark size={14} />
                    <span>Save</span>
                  </button>
                </div>
              </div>
            </article>
          ))}
        </div>

        <!-- Load More -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem; text-align: center;">
          <a href="/new/page/2" style="color: var(--brand); text-decoration: none; font-weight: 600; font-size: 0.875rem;">Load More Posts â†’</a>
        </div>
      </div>

      <!-- Right Sidebar - Stats & Info -->
      <aside class="sidebar-right">
        <!-- Community Stats -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem;">
          <h3 style="font-size: 1rem; font-weight: 800; margin: 0 0 1rem 0; color: var(--text-primary);">VapeIndex Community</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div>
              <div style="font-size: 1.75rem; font-weight: 900; color: var(--text-primary);">{stats.totalMembers.toLocaleString()}</div>
              <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">Total Members</div>
            </div>
            <div>
              <div style="font-size: 1.75rem; font-weight: 900; color: var(--text-primary);">{stats.activeNow.toLocaleString()}</div>
              <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">ðŸŸ¢ Active Now</div>
            </div>
            <div>
              <div style="font-size: 1.75rem; font-weight: 900; color: var(--text-primary);">{stats.totalPosts.toLocaleString()}</div>
              <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">Total Posts</div>
            </div>
            <div>
              <div style="font-size: 1.75rem; font-weight: 900; color: var(--text-primary);">{stats.boardsCount}</div>
              <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">Active Boards</div>
            </div>
          </div>
        </div>

        <!-- Trending Boards -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem;">
          <h3 style="font-size: 1rem; font-weight: 800; margin: 0 0 0.75rem 0; color: var(--text-primary);">Trending Boards</h3>
          {trendingBoards.map((board, i) => (
            <a href={`/b/${board.slug}`} style="display: block; padding: 0.5rem 0; color: var(--text-primary); text-decoration: none; border-bottom: 1px solid var(--divider);">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-weight: 800; color: var(--text-primary); font-size: 1rem;">{i + 1}</span>
                <div style="flex: 1;">
                  <div style="font-weight: 700; font-size: 0.875rem; color: var(--text-primary);">b/{board.slug}</div>
                  <div style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 600;">{board.members.toLocaleString()} members</div>
                </div>
              </div>
            </a>
          ))}
        </div>

        <!-- Quick Links -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem;">
          <h3 style="font-size: 1rem; font-weight: 800; margin: 0 0 0.75rem 0; color: var(--text-primary);">Quick Links</h3>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
            <a href="/rules" style="color: var(--text-primary); text-decoration: none; font-weight: 600;">Community Rules</a>
            <a href="/guidelines" style="color: var(--text-primary); text-decoration: none; font-weight: 600;">Posting Guidelines</a>
            <a href="/faq" style="color: var(--text-primary); text-decoration: none; font-weight: 600;">FAQ</a>
            <a href="/prices" style="color: var(--brand); text-decoration: none; font-weight: 700;">Price Tracker</a>
            <a href="/api" style="color: var(--text-primary); text-decoration: none; font-weight: 600;">API Docs</a>
          </div>
        </div>
      </aside>

    </div>
  </main>
</Layout>

<style>
  .main-content {
    background: var(--bg-secondary);
    min-height: 100vh;
  }

  .layout-container {
    max-width: var(--max-width-full);
    margin: 0 auto;
    padding: var(--container-padding);
    display: grid;
    gap: var(--layout-gap);
    grid-template-columns: 1fr;
  }

  .sidebar-left,
  .sidebar-right {
    display: none;
  }

  .sidebar-left {
    display: flex;
    flex-direction: column;
    gap: var(--layout-gap);
    position: sticky;
    top: var(--space-2);
    align-self: start;
  }

  .sidebar-right {
    display: flex;
    flex-direction: column;
    gap: var(--layout-gap);
    position: sticky;
    top: var(--space-2);
    align-self: start;
  }

  .main-feed {
    display: flex;
    flex-direction: column;
    gap: var(--section-gap);
    min-width: 0;
  }

  .filter-bar {
    background: var(--bg-elevated);
    border: 1px solid var(--border-primary);
    padding: var(--space-2) var(--space-3);
    display: flex;
    gap: var(--space-3);
    align-items: center;
    justify-content: space-between;
  }

  .filter-tabs {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
    flex: 1;
  }

  .filter-tab {
    color: var(--text-tertiary);
    text-decoration: none;
    padding: var(--space-1) var(--space-2);
    font-weight: 400;
    font-size: 0.8125rem;
    white-space: nowrap;
    transition: color 0.1s ease;
  }

  .filter-tab.active {
    color: var(--text-primary);
    font-weight: 600;
  }

  .filter-tab:hover {
    color: var(--brand);
  }

  .filter-actions {
    flex-shrink: 0;
  }

  .create-post-btn {
    color: var(--brand);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.8125rem;
    white-space: nowrap;
    transition: color 0.1s ease;
  }

  .create-post-btn:hover {
    color: var(--brand-dark);
  }

  /* Wide Desktop - Show all 3 columns */
  @media (min-width: 1400px) {
    .layout-container {
      grid-template-columns: var(--sidebar-left-width) 1fr var(--sidebar-right-width);
      gap: var(--layout-gap);
    }

    .sidebar-left,
    .sidebar-right {
      display: flex;
    }
  }

  /* Desktop - Show main + right sidebar */
  @media (min-width: 1200px) and (max-width: 1399px) {
    .layout-container {
      grid-template-columns: 1fr var(--sidebar-right-width);
      gap: var(--space-3);
    }

    .sidebar-left {
      display: none;
    }

    .sidebar-right {
      display: flex;
    }
  }

  /* Tablet - Main content only */
  @media (min-width: 769px) and (max-width: 1199px) {
    .layout-container {
      max-width: var(--max-width-content);
      grid-template-columns: 1fr;
      gap: var(--layout-gap);
    }

    .sidebar-left,
    .sidebar-right {
      display: none;
    }
  }

  /* Mobile */
  @media (max-width: 768px) {
    .layout-container {
      padding: var(--space-2);
      grid-template-columns: 1fr;
    }

    .sidebar-left,
    .sidebar-right {
      display: none;
    }

    .filter-bar {
      padding: var(--space-2);
      gap: var(--space-2);
    }

    .filter-tabs {
      gap: var(--space-1);
      width: 100%;
    }

    .filter-tab {
      padding: var(--space-2) var(--space-3);
      font-size: 0.8125rem;
      flex: 1;
      text-align: center;
      min-width: 0;
    }

    .filter-actions {
      width: 100%;
    }

    .create-post-btn {
      width: 100%;
      text-align: center;
      padding: var(--space-3);
    }
  }

  @media (max-width: 480px) {
    .filter-tab {
      font-size: 0.75rem;
      padding: var(--space-2) var(--space-2);
    }

    .filter-tab:not(.active) {
      font-size: 0.6875rem;
    }
  }
</style>
