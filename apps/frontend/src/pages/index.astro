---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { ChevronUp, ChevronDown, MessageSquare, Eye, Share2, Bookmark } from 'lucide-astro';
import { fetchPosts, fetchBoards, fetchStats } from '../lib/api';

// Fetch real data from API
const [topPosts, boards, stats] = await Promise.all([
  fetchPosts('hot', 15),
  fetchBoards(),
  fetchStats()
]);

const trendingBoards = boards.slice(0, 4);

// Old mock data (backup):
const oldPosts = [
  { id: '1', title: 'Best disposable vapes of 2025? Looking for recommendations', board: 'Disposables', boardSlug: 'disposables', score: 287, comments: 94, author: 'vapeenthusiast', authorKarma: 2847, time: '3h', views: 1847, hot: true, awarded: true },
  { id: '2', title: 'PSA: Fake Elf Bars flooding the market - How to spot them', board: 'Disposables', boardSlug: 'disposables', score: 512, comments: 143, author: 'authentic_only', authorKarma: 5234, time: '5h', views: 4234, hot: true, awarded: true },
  { id: '3', title: 'Pax 3 vs Mighty+ - Full comparison with photos', board: 'Dry Herb', boardSlug: 'dryherb', score: 164, comments: 121, author: 'herb_connoisseur', authorKarma: 3456, time: '7h', views: 1923, hot: false, awarded: false },
  { id: '4', title: 'Caliburn G2 pods leaking after 2 days - any solutions?', board: 'Pod Systems', boardSlug: 'pods', score: 89, comments: 45, author: 'pod_user', authorKarma: 234, time: '9h', views: 1247, hot: false, awarded: false },
  { id: '5', title: 'VaporDNA 30% off sale - today only! Code: VAPE30', board: 'Deals', boardSlug: 'deals', score: 456, comments: 87, author: 'deal_hunter', authorKarma: 8901, time: '11h', views: 5632, hot: true, awarded: true },
  { id: '6', title: 'Freebase vs salt nicotine - comprehensive beginner guide', board: 'Reviews', boardSlug: 'reviews', score: 203, comments: 32, author: 'nic_expert', authorKarma: 12456, time: '14h', views: 3421, hot: false, awarded: false },
  { id: '7', title: 'Battery safety - what EVERY vaper needs to know', board: 'Mods & Tanks', boardSlug: 'mods', score: 392, comments: 156, author: 'safety_first', authorKarma: 15234, time: '16h', views: 6234, hot: true, awarded: true },
  { id: '8', title: 'New Elf Bar BC5000 flavors just dropped - tried them all', board: 'Disposables', boardSlug: 'disposables', score: 178, comments: 56, author: 'flavor_king', authorKarma: 1823, time: '18h', views: 2145, hot: false, awarded: false },
  { id: '9', title: 'Smok RPM4 - is it worth upgrading from RPM3?', board: 'Pod Systems', boardSlug: 'pods', score: 67, comments: 28, author: 'smok_fan', authorKarma: 456, time: '20h', views: 987, hot: false, awarded: false },
  { id: '10', title: 'Share your current vape setup! [Photos]', board: 'Show', boardSlug: 'show', score: 234, comments: 89, author: 'setup_share', authorKarma: 2134, time: '22h', views: 3156, hot: false, awarded: false },
  { id: '11', title: 'Built my first triple-core fused clapton coils! Tips?', board: 'DIY', boardSlug: 'diy', score: 145, comments: 67, author: 'coil_builder', authorKarma: 987, time: '1d', views: 1456, hot: false, awarded: false },
  { id: '12', title: 'Complete beginner - what device should I buy?', board: 'Beginner', boardSlug: 'beginner', score: 98, comments: 73, author: 'newbie2025', authorKarma: 12, time: '1d', views: 1892, hot: false, awarded: false },
  { id: '13', title: 'Storz & Bickel Mighty+ price tracking - all time low?', board: 'Deals', boardSlug: 'deals', score: 267, comments: 41, author: 'price_watcher', authorKarma: 6734, time: '1d', views: 2734, hot: false, awarded: false },
  { id: '14', title: 'Lost Vape Thelema DNA250C - 6 month review', board: 'Reviews', boardSlug: 'reviews', score: 189, comments: 52, author: 'reviewer_pro', authorKarma: 9234, time: '1d', views: 2341, hot: false, awarded: false },
  { id: '15', title: 'Anyone tried the new Geek Bar Pulse? Thoughts?', board: 'Disposables', boardSlug: 'disposables', score: 134, comments: 48, author: 'disposable_fan', authorKarma: 1234, time: '2d', views: 1678, hot: false, awarded: false },
];
---

<Layout>
  <Header />

  <main class="main-content">
    <div class="layout-container">

      <!-- Left Sidebar - Boards -->
      <aside class="sidebar-left">
        <!-- Create Board CTA -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem;">
          <div style="font-weight: 800; font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-primary);">Create Your Community</div>
          <p style="font-size: 0.8125rem; color: var(--text-secondary); margin: 0 0 0.75rem 0; line-height: 1.5;">
            Start a new board and build your own community around any vaping topic.
          </p>
          <a href="/create-board" style="display: block; background: var(--brand); color: white; padding: 0.5rem 1rem; border-radius: 0; text-align: center; font-weight: 700; font-size: 0.875rem; text-decoration: none;">
            + Create Board
          </a>
        </div>

        <!-- Boards List -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary);">
          <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-primary);">
            <h3 style="font-size: 0.875rem; font-weight: 800; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">
              Browse Boards
            </h3>
          </div>
          <div style="max-height: 500px; overflow-y: auto;">
            {boards.map(board => (
              <a href={`/b/${board.slug}`} style={`display: block; padding: 0.75rem 1rem; color: var(--text-primary); text-decoration: none; border-left: 3px solid ${board.color}; border-bottom: 1px solid var(--divider);`}>
                <div style="font-weight: 700; font-size: 0.9375rem; margin-bottom: 0.25rem; color: var(--text-primary);">{board.name}</div>
                <div style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.375rem;">{board.description}</div>
                <div style="font-size: 0.75rem; color: var(--text-primary); display: flex; gap: 1rem; font-weight: 600;">
                  <span>{board.posts.toLocaleString()} posts</span>
                  <span>{board.members.toLocaleString()} members</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </aside>

      <!-- Main Content - Posts Feed -->
      <div class="main-feed">
        <!-- Filter Bar -->
        <div class="filter-bar">
          <div class="filter-tabs">
            <a href="/" class="filter-tab active">hot</a>
            <a href="/new" class="filter-tab">new</a>
            <a href="/top" class="filter-tab">top</a>
            <a href="/rising" class="filter-tab">rising</a>
          </div>
          <div class="filter-actions">
            <a href="/submit" class="create-post-btn">submit</a>
          </div>
        </div>

        <!-- Posts List -->
        <div class="posts-container">
          {topPosts.map((post, i) => (
            <article class="post-card">
              <!-- Voting Column -->
              <div class="vote-column">
                <button class="vote-btn vote-up" aria-label="Upvote">
                  <ChevronUp size={16} />
                </button>
                <span class="vote-score">{post.score}</span>
                <button class="vote-btn vote-down" aria-label="Downvote">
                  <ChevronDown size={16} />
                </button>
              </div>

              <!-- Content Column -->
              <div class="post-content">
                <!-- Meta Info -->
                <div class="post-meta">
                  <a href={`/b/${post.boardSlug}`} class="board-tag" style={`color: ${boards.find(b => b.slug === post.boardSlug)?.color || '#7C3AED'}`}>
                    b/{post.boardSlug}
                  </a>
                  <span class="meta-separator">‚Ä¢</span>
                  <span class="post-author">
                    <a href={`/u/${post.author}`} class="author-link">u/{post.author}</a>
                    <span class="author-karma">{post.authorKarma.toLocaleString()}</span>
                  </span>
                  <span class="meta-separator">‚Ä¢</span>
                  <time class="post-time">{post.time}</time>
                  {post.hot && <span class="badge badge-hot">üî• HOT</span>}
                  {post.awarded && <span class="badge badge-award">‚≠ê</span>}
                </div>

                <!-- Title -->
                <h2 class="post-title">
                  <a href={`/post/${post.id}`}>{post.title}</a>
                </h2>

                <!-- Actions -->
                <div class="post-actions">
                  <a href={`/post/${post.id}`} class="action-btn action-comment">
                    <MessageSquare size={14} />
                    <span>{post.comments}</span>
                  </a>
                  <span class="action-btn action-views">
                    <Eye size={14} />
                    <span>{post.views.toLocaleString()}</span>
                  </span>
                  <button class="action-btn action-share">
                    <Share2 size={14} />
                    <span>Share</span>
                  </button>
                  <button class="action-btn action-save">
                    <Bookmark size={14} />
                    <span>Save</span>
                  </button>
                </div>
              </div>
            </article>
          ))}
        </div>

        <!-- Load More -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem; text-align: center;">
          <a href="/page/2" style="color: var(--brand); text-decoration: none; font-weight: 600; font-size: 0.875rem;">Load More Posts ‚Üí</a>
        </div>
      </div>

      <!-- Right Sidebar - Stats & Info -->
      <aside class="sidebar-right">
        <!-- Community Stats -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem;">
          <h3 style="font-size: 1rem; font-weight: 800; margin: 0 0 1rem 0; color: var(--text-primary);">VapeIndex Community</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div>
              <div style="font-size: 1.75rem; font-weight: 900; color: var(--text-primary);">{stats.totalMembers.toLocaleString()}</div>
              <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">Total Members</div>
            </div>
            <div>
              <div style="font-size: 1.75rem; font-weight: 900; color: var(--text-primary);">{stats.activeNow.toLocaleString()}</div>
              <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">üü¢ Active Now</div>
            </div>
            <div>
              <div style="font-size: 1.75rem; font-weight: 900; color: var(--text-primary);">{stats.totalPosts.toLocaleString()}</div>
              <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">Total Posts</div>
            </div>
            <div>
              <div style="font-size: 1.75rem; font-weight: 900; color: var(--text-primary);">{stats.boardsCount}</div>
              <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">Active Boards</div>
            </div>
          </div>
        </div>

        <!-- Trending Boards -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem;">
          <h3 style="font-size: 1rem; font-weight: 800; margin: 0 0 0.75rem 0; color: var(--text-primary);">Trending Boards</h3>
          {trendingBoards.map((board, i) => (
            <a href={`/b/${board.slug}`} style="display: block; padding: 0.5rem 0; color: var(--text-primary); text-decoration: none; border-bottom: 1px solid var(--divider);">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-weight: 800; color: var(--text-primary); font-size: 1rem;">{i + 1}</span>
                <div style="flex: 1;">
                  <div style="font-weight: 700; font-size: 0.875rem; color: var(--text-primary);">b/{board.slug}</div>
                  <div style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 600;">{board.members.toLocaleString()} members</div>
                </div>
              </div>
            </a>
          ))}
        </div>

        <!-- Quick Links -->
        <div style="background: var(--bg-elevated); border: 1px solid var(--border-primary); padding: 1rem;">
          <h3 style="font-size: 1rem; font-weight: 800; margin: 0 0 0.75rem 0; color: var(--text-primary);">Quick Links</h3>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
            <a href="/rules" style="color: var(--text-primary); text-decoration: none; font-weight: 600;">Community Rules</a>
            <a href="/guidelines" style="color: var(--text-primary); text-decoration: none; font-weight: 600;">Posting Guidelines</a>
            <a href="/faq" style="color: var(--text-primary); text-decoration: none; font-weight: 600;">FAQ</a>
            <a href="/prices" style="color: var(--brand); text-decoration: none; font-weight: 700;">Price Tracker</a>
            <a href="/api" style="color: var(--text-primary); text-decoration: none; font-weight: 600;">API Docs</a>
          </div>
        </div>
      </aside>

    </div>
  </main>

  <style>
    .main-content {
      background: var(--bg-secondary);
      min-height: 100vh;
    }

    .layout-container {
      max-width: var(--max-width-full);
      margin: 0 auto;
      padding: var(--container-padding);
      display: grid;
      gap: var(--layout-gap);
      grid-template-columns: 1fr;
    }

    .sidebar-left,
    .sidebar-right {
      display: none;
    }

    .sidebar-left {
      display: flex;
      flex-direction: column;
      gap: var(--layout-gap);
      position: sticky;
      top: var(--space-2);
      align-self: start;
    }

    .sidebar-right {
      display: flex;
      flex-direction: column;
      gap: var(--layout-gap);
      position: sticky;
      top: var(--space-2);
      align-self: start;
    }

    .main-feed {
      display: flex;
      flex-direction: column;
      gap: var(--section-gap);
      min-width: 0;
    }

    .filter-bar {
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      padding: var(--space-2) var(--space-3);
      display: flex;
      gap: var(--space-3);
      align-items: center;
      justify-content: space-between;
    }

    .filter-tabs {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
      flex: 1;
    }

    .filter-tab {
      color: var(--text-tertiary);
      text-decoration: none;
      padding: var(--space-1) var(--space-2);
      font-weight: 400;
      font-size: 0.8125rem;
      white-space: nowrap;
      transition: color 0.1s ease;
    }

    .filter-tab.active {
      color: var(--text-primary);
      font-weight: 600;
    }

    .filter-tab:hover {
      color: var(--brand);
    }

    .filter-actions {
      flex-shrink: 0;
    }

    .create-post-btn {
      color: var(--brand);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.8125rem;
      white-space: nowrap;
      transition: color 0.1s ease;
    }

    .create-post-btn:hover {
      color: var(--brand-dark);
    }

    /* Wide Desktop - Show all 3 columns */
    @media (min-width: 1400px) {
      .layout-container {
        grid-template-columns: var(--sidebar-left-width) 1fr var(--sidebar-right-width);
        gap: var(--layout-gap);
      }

      .sidebar-left,
      .sidebar-right {
        display: flex;
      }
    }

    /* Desktop - Show main + right sidebar */
    @media (min-width: 1200px) and (max-width: 1399px) {
      .layout-container {
        grid-template-columns: 1fr var(--sidebar-right-width);
        gap: var(--space-3);
      }

      .sidebar-left {
        display: none;
      }

      .sidebar-right {
        display: flex;
      }
    }

    /* Tablet - Main content only */
    @media (min-width: 769px) and (max-width: 1199px) {
      .layout-container {
        max-width: var(--max-width-content);
        grid-template-columns: 1fr;
        gap: var(--layout-gap);
      }

      .sidebar-left,
      .sidebar-right {
        display: none;
      }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .layout-container {
        padding: var(--space-2);
        grid-template-columns: 1fr;
      }

      .sidebar-left,
      .sidebar-right {
        display: none;
      }

      .filter-bar {
        padding: var(--space-2);
        gap: var(--space-2);
      }

      .filter-tabs {
        gap: var(--space-1);
        width: 100%;
      }

      .filter-tab {
        padding: var(--space-2) var(--space-3);
        font-size: 0.8125rem;
        flex: 1;
        text-align: center;
        min-width: 0;
      }

      .filter-actions {
        width: 100%;
      }

      .create-post-btn {
        width: 100%;
        text-align: center;
        padding: var(--space-3);
      }
    }

    @media (max-width: 480px) {
      .filter-tab {
        font-size: 0.75rem;
        padding: var(--space-2) var(--space-2);
      }

      .filter-tab:not(.active) {
        font-size: 0.6875rem;
      }
    }
  </style>

    <!-- Footer -->
    <footer style="margin-top: 4rem; padding: 2rem 0; border-top: 1px solid var(--border-primary); text-align: center; color: var(--text-muted);">
      <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 0.5rem; font-size: 0.9375rem;">
        <a href="/about" style="color: var(--text-muted);">About</a>
        <a href="/guidelines" style="color: var(--text-muted);">Guidelines</a>
        <a href="/faq" style="color: var(--text-muted);">FAQ</a>
        <a href="/contact" style="color: var(--text-muted);">Contact</a>
        <a href="/privacy" style="color: var(--text-muted);">Privacy</a>
        <a href="/terms" style="color: var(--text-muted);">Terms</a>
      </div>
      <p style="font-size: 0.875rem; opacity: 0.7;">¬© 2025 VapeIndex. All rights reserved.</p>
    </footer>
  </main>
</Layout>
