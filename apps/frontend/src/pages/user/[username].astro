---
import Layout from '../../layouts/Layout.astro';

const { username } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:51728';

let userData = null;
let error = null;

try {
  const response = await fetch(`${API_URL}/api/users/${username}`);
  if (response.ok) {
    userData = await response.json();
  } else {
    error = 'User not found';
  }
} catch (e) {
  error = 'Failed to load user data';
}
---

<Layout title={username ? `u/${username}` : 'User Profile'}>
  <div class="profile-container">
    {error ? (
      <div class="error-message">
        <h2>Error</h2>
        <p>{error}</p>
        <a href="/">← Back to home</a>
      </div>
    ) : userData && (
      <>
        <div class="profile-header">
          <div class="profile-info">
            <h1>u/{userData.user.username}</h1>
            <div class="profile-stats">
              <div class="stat">
                <span class="stat-value">{userData.user.karma}</span>
                <span class="stat-label">karma</span>
              </div>
              <div class="stat">
                <span class="stat-value">{userData.user.accountAge}</span>
                <span class="stat-label">account age</span>
              </div>
              <div class="stat">
                <span class="stat-value">{userData.posts.length}</span>
                <span class="stat-label">posts</span>
              </div>
              <div class="stat">
                <span class="stat-value">{userData.comments.length}</span>
                <span class="stat-label">comments</span>
              </div>
            </div>
          </div>
        </div>

        <div class="profile-content">
          <div class="tab-container">
            <button class="tab active" data-tab="posts">Posts</button>
            <button class="tab" data-tab="comments">Comments</button>
          </div>

          <div class="tab-content" id="posts-content">
            {userData.posts.length === 0 ? (
              <p class="no-content">No posts yet</p>
            ) : (
              <div class="posts-list">
                {userData.posts.map((post: any) => (
                  <div class="post-item">
                    <div class="post-score">{post.score}</div>
                    <div class="post-details">
                      <a href={`/post/${post.id}`} class="post-title">{post.title}</a>
                      <div class="post-meta">
                        <a href={`/b/${post.boardSlug}`} class="post-board">b/{post.boardSlug}</a>
                        <span>•</span>
                        <span>{post.comments} comments</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div class="tab-content hidden" id="comments-content">
            {userData.comments.length === 0 ? (
              <p class="no-content">No comments yet</p>
            ) : (
              <div class="comments-list">
                {userData.comments.map((comment: any) => (
                  <div class="comment-item">
                    <div class="comment-score">{comment.score}</div>
                    <div class="comment-details">
                      <div class="comment-context">
                        on <a href={`/post/${comment.postId}`} class="comment-post">{comment.postTitle}</a>
                        {' '}in <a href={`/b/${comment.boardSlug}`} class="comment-board">b/{comment.boardSlug}</a>
                      </div>
                      <div class="comment-content">{comment.content}</div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </>
    )}
  </div>
</Layout>

<style>
  .profile-container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
  .error-message { text-align: center; padding: 4rem 2rem; }
  .error-message h2 { font-size: 1.5rem; margin-bottom: 1rem; }
  .error-message a { color: var(--brand); text-decoration: none; }

  .profile-header { background: var(--bg-secondary); padding: 2rem; border-radius: 8px; margin-bottom: 2rem; }
  .profile-info h1 { font-size: 2rem; margin-bottom: 1rem; }
  .profile-stats { display: flex; gap: 2rem; }
  .stat { display: flex; flex-direction: column; }
  .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--brand); }
  .stat-label { font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; }

  .tab-container { display: flex; gap: 1rem; border-bottom: 2px solid var(--border); margin-bottom: 1.5rem; }
  .tab { background: none; border: none; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
  .tab:hover { color: var(--text-primary); }
  .tab.active { color: var(--brand); border-bottom-color: var(--brand); }

  .tab-content { min-height: 400px; }
  .tab-content.hidden { display: none; }
  .no-content { text-align: center; padding: 4rem 2rem; color: var(--text-secondary); font-style: italic; }

  .posts-list, .comments-list { display: flex; flex-direction: column; gap: 1rem; }

  .post-item, .comment-item { display: flex; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px; }
  .post-score, .comment-score { font-weight: 700; font-size: 1.25rem; color: var(--text-secondary); min-width: 50px; text-align: center; }
  .post-details, .comment-details { flex: 1; }
  .post-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); text-decoration: none; display: block; margin-bottom: 0.5rem; }
  .post-title:hover { color: var(--brand); }
  .post-meta { font-size: 0.875rem; color: var(--text-secondary); display: flex; gap: 0.5rem; }
  .post-board, .comment-board { color: var(--brand); text-decoration: none; font-weight: 600; }

  .comment-context { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
  .comment-post { color: var(--text-primary); text-decoration: none; font-weight: 500; }
  .comment-post:hover { color: var(--brand); }
  .comment-content { line-height: 1.6; color: var(--text-primary); }
</style>

<script>
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.getAttribute('data-tab');

      // Update active tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      // Show corresponding content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${tabName}-content`)?.classList.remove('hidden');
    });
  });
</script>
