---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import VoteButtons from '../../components/VoteButtons.astro';
import Comments from '../../components/Comments.astro';

const { id } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:51728';

let post: any = null;
let error = null;

try {
  const response = await fetch(`${API_URL}/api/posts/${id}`);
  if (response.ok) {
    post = await response.json();
  } else {
    error = 'Post not found';
  }
} catch (e) {
  error = 'Failed to load post';
}
---

<Layout title={post ? post.title : 'Post'}>
  <Header />

  <main class="main-content">
    {error ? (
      <div class="error-container">
        <h2>Error</h2>
        <p>{error}</p>
        <a href="/">← Back to home</a>
      </div>
    ) : post && (
      <div class="post-container">
        <article class="post-detail">
          <div class="post-vote">
            <VoteButtons postId={post.id} score={post.score} type="post" />
          </div>

          <div class="post-main">
            <div class="post-meta">
              <a href={`/b/${post.boardSlug}`} class="board-link" style={`color: ${post.boardColor}`}>
                b/{post.boardSlug}
              </a>
              <span>•</span>
              <span>Posted by</span>
              <a href={`/user/${post.author}`} class="author-link">u/{post.author}</a>
              <span>•</span>
              <span class="post-time" data-timestamp={post.createdAt}></span>
              {post.editedAt && (
                <span class="edited-indicator" data-edited={post.editedAt}></span>
              )}
            </div>

            <h1 class="post-title">{post.title}</h1>

            {post.url ? (
              <div class="post-url">
                <a href={post.url} target="_blank" rel="noopener noreferrer" class="external-link">
                  {post.url}
                  <span class="external-icon">↗</span>
                </a>
              </div>
            ) : post.content && (
              <div class="post-content" id="post-content">{post.content}</div>
            )}

            <div class="post-actions" id="post-actions" data-post-id={post.id} data-author-id={post.authorId}>
              <button class="action-btn edit-post-btn" style="display: none;">Edit</button>
              <button class="action-btn delete-post-btn" style="display: none;">Delete</button>
              <button class="action-btn share-btn">Share</button>
            </div>

            <form class="edit-form" id="edit-post-form" style="display: none;">
              <input type="text" id="edit-post-title" placeholder="Title" />
              <textarea id="edit-post-content" placeholder="Content" required></textarea>
              <div class="form-actions">
                <button type="submit">Save</button>
                <button type="button" class="cancel-edit">Cancel</button>
              </div>
            </form>
          </div>
        </article>

        <Comments postId={post.id} />
      </div>
    )}
  </main>
</Layout>

<style>
  .main-content { background: var(--bg-secondary); min-height: 100vh; padding: 1rem; }
  .error-container { text-align: center; padding: 4rem 2rem; max-width: 600px; margin: 0 auto; }
  .error-container h2 { font-size: 1.5rem; margin-bottom: 1rem; }
  .error-container a { color: var(--brand); text-decoration: none; }

  .post-container { max-width: 800px; margin: 0 auto; }

  .post-detail {
    background: var(--bg-elevated);
    border: 1px solid var(--border-primary);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    gap: 1rem;
  }

  .post-vote { flex-shrink: 0; }
  .post-main { flex: 1; min-width: 0; }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .board-link { font-weight: 700; text-decoration: none; }
  .author-link { color: var(--text-primary); text-decoration: none; font-weight: 600; }
  .author-link:hover { color: var(--brand); }
  .edited-indicator { font-size: 0.8125rem; font-style: italic; color: var(--text-tertiary); }

  .post-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 1rem 0;
    line-height: 1.3;
    color: var(--text-primary);
  }

  .post-url {
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 4px;
  }

  .external-link {
    color: var(--brand);
    text-decoration: none;
    word-break: break-all;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }
  .external-link:hover { text-decoration: underline; }

  .post-content {
    line-height: 1.6;
    color: var(--text-primary);
    margin-bottom: 1rem;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .post-actions {
    display: flex;
    gap: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
  }

  .action-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
  }
  .action-btn:hover { color: var(--brand); }

  .edit-form {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
  }

  .edit-form input,
  .edit-form textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    font-family: inherit;
    margin-bottom: 0.75rem;
  }

  .edit-form textarea { min-height: 150px; resize: vertical; }

  .form-actions { display: flex; gap: 0.5rem; }
  .form-actions button { padding: 0.5rem 1rem; font-weight: 600; cursor: pointer; }
  .form-actions button[type="submit"] { background: var(--brand); color: white; border: none; }
  .form-actions .cancel-edit { background: none; border: 1px solid var(--border); color: var(--text-secondary); }

  @media (max-width: 768px) {
    .post-detail { flex-direction: column; padding: 1rem; }
  }
</style>

<script>
  import { isAuthenticated, getStoredUser } from '../../lib/auth';

  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:51728';

  // Format time
  document.querySelectorAll('.post-time').forEach(el => {
    const timestamp = parseInt(el.getAttribute('data-timestamp') || '0');
    const now = Math.floor(Date.now() / 1000);
    const age = now - timestamp;
    let time = '';
    if (age < 3600) time = `${Math.floor(age / 60)}m ago`;
    else if (age < 86400) time = `${Math.floor(age / 3600)}h ago`;
    else if (age < 2592000) time = `${Math.floor(age / 86400)}d ago`;
    else if (age < 31536000) time = `${Math.floor(age / 2592000)}mo ago`;
    else time = `${Math.floor(age / 31536000)}y ago`;
    el.textContent = time;
  });

  // Show edit/delete if author
  const postActions = document.getElementById('post-actions');
  if (postActions) {
    const authorId = parseInt(postActions.getAttribute('data-author-id') || '0');
    const user = getStoredUser();
    if (user && user.id === authorId) {
      const editBtn = postActions.querySelector('.edit-post-btn') as HTMLElement;
      const deleteBtn = postActions.querySelector('.delete-post-btn') as HTMLElement;
      if (editBtn) editBtn.style.display = 'block';
      if (deleteBtn) deleteBtn.style.display = 'block';
    }
  }

  // Edit/delete handlers
  const editBtn = document.querySelector('.edit-post-btn');
  const editForm = document.getElementById('edit-post-form') as HTMLFormElement;
  const postContent = document.getElementById('post-content');

  editBtn?.addEventListener('click', () => {
    if (postContent && editForm) {
      (document.getElementById('edit-post-content') as HTMLTextAreaElement).value = postContent.textContent || '';
      postContent.style.display = 'none';
      editForm.style.display = 'block';
    }
  });

  document.querySelector('.cancel-edit')?.addEventListener('click', () => {
    if (postContent && editForm) {
      postContent.style.display = 'block';
      editForm.style.display = 'none';
    }
  });

  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!isAuthenticated()) { window.location.href = '/login'; return; }
    const postId = postActions?.getAttribute('data-post-id');
    const token = localStorage.getItem('auth_token');
    const res = await fetch(`${API_URL}/api/posts/${postId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        title: (document.getElementById('edit-post-title') as HTMLInputElement).value,
        content: (document.getElementById('edit-post-content') as HTMLTextAreaElement).value
      }),
    });
    if (res.ok) window.location.reload();
    else alert((await res.json()).error || 'Failed to edit post');
  });

  document.querySelector('.delete-post-btn')?.addEventListener('click', async () => {
    if (!confirm('Delete this post? This cannot be undone.')) return;
    if (!isAuthenticated()) { window.location.href = '/login'; return; }
    const postId = postActions?.getAttribute('data-post-id');
    const token = localStorage.getItem('auth_token');
    const res = await fetch(`${API_URL}/api/posts/${postId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` },
    });
    if (res.ok) window.location.href = '/';
    else alert((await res.json()).error || 'Failed to delete post');
  });
</script>
</Layout>
